---

- name: Create directory for keypair
  file:
    path: "{{ ssh_keypair_location }}"
    state: directory
    mode: u=rwx,g=,o=

- name: Generate SSH keypair for accessing the targets
  openssh_keypair:
    type: rsa
    state: present
    size: 4096
    comment: "key-{{ current_user }}"
    path: "{{ ssh_keypair_location }}/{{ keypair_file }}"
    owner: "{{ current_user }}"
    mode: u=rw,g=,o=

- name: Store keys in variables  
  set_fact:
    vault_ssh_priv: "{{ lookup('file',  '{{ ssh_keypair_location }}/{{keypair_file}}') }}"
    vault_ssh_pub: "{{ lookup('file',  '{{ ssh_keypair_location }}/{{keypair_file}}.pub') }}"

- name: remove priv keypair from disk
  file:
    state: absent
    path: "{{ ssh_keypair_location }}/{{ keypair_file }}"

- name: remove pub keypair from disk
  file:
    state: absent
    path: "{{ ssh_keypair_location }}/{{ keypair_file }}.pub"
